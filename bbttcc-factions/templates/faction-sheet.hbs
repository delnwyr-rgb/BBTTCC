{{!-- bbttcc-factions/templates/faction-sheet.hbs --}}
<form class="bbttcc-faction-sheet flexcol">
  <header class="sheet-header flexcol" style="gap:.5rem; margin-bottom:.5rem;">
    <div class="flexrow" style="align-items:center; gap:1rem;">
      <img class="profile" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" width="64" height="64" style="border-radius:8px; cursor:pointer;"/>
      <h1 class="charname" style="margin:0; flex:1;">
        <input name="name" type="text" value="{{actor.name}}" />
      </h1>
    </div>

    <div class="flexrow" style="gap:1rem; justify-content:space-between; align-items:center;">
      <div class="flexrow" style="gap:.5rem; align-items:center;">
        <strong>{{localize "BBTTCC.Labels.Status"}}:</strong>
        <span class="badge" style="padding:.15rem .5rem; border-radius:.5rem; background:#243b55; color:white;">
          {{fx.powerLevelLabel}}
        </span>
      </div>
      <div>
        <strong>{{localize "BBTTCC.Labels.TotalOPs"}}:</strong> {{fx.totalOPs}} / {{fx.maxOPs}}
      </div>
    </div>
  </header>

  <section class="bbttcc-faction-body flexcol" style="gap:1rem;">

    {{!-- ===================== TERRITORY ROLL-UP (ALL SCENES) ===================== --}}
    {{#if fx.territoryTotals}}
    <fieldset style="border:1px solid #666; border-radius:8px; padding:.6rem;">
      <legend style="padding:0 .25rem;">BBTTCC — Territory Roll-up</legend>
      <div class="flexrow" style="gap:1rem; align-items:center;">
        <div><strong>Owned Hexes:</strong> {{fx.territoryTotals.count}}</div>
        <div><strong>Resources (per turn):</strong>
          Food {{fx.territoryTotals.resources.food}} •
          Materials {{fx.territoryTotals.resources.materials}} •
          Trade {{fx.territoryTotals.resources.trade}} •
          Military {{fx.territoryTotals.resources.military}} •
          Knowledge {{fx.territoryTotals.resources.knowledge}} •
          Technology {{fx.territoryTotals.resources.technology}}
        </div>
      </div>
      <div style="margin-top:.25rem;">
        <strong>Defense:</strong> {{fx.territoryTotals.defenseTotal}}
      </div>
    </fieldset>
    {{/if}}

    {{!-- ===================== OP BUDGET (no per-bucket max cap) ===================== --}}
    <fieldset style="border:1px solid #666; border-radius:8px; padding:.6rem;">
      <legend style="padding:0 .25rem;">{{localize "BBTTCC.Labels.OrganizationPoints"}}</legend>

      <div class="form-group" style="margin-bottom:.5rem;">
        <label style="font-weight:600; display:block;">Max OPs</label>
        <input type="number" name="fx.maxOPs" value="{{fx.maxOPs}}" min="0" step="1" style="width:8rem;" />
        <p class="hint" style="opacity:.75; margin:.25rem 0 0;">
          Overall budget (informational). Per-category caps are not enforced.
        </p>
      </div>

      <table class="bbttcc-table" style="width:100%;">
        <thead>
          <tr>
            <th style="text-align:left;">Category</th>
            <th style="width:10rem;">Value</th>
            <th style="width:9rem;">Roster</th>
            <th style="width:8rem;">Total</th>
            <th style="width:9rem;">Roll</th>
            <th style="width:8rem;">Adjust</th>
          </tr>
        </thead>
        <tbody>
          {{#each fx.ops}}
          <tr>
            <td><label for="fx.ops.{{key}}.value">{{label}}</label></td>

            <td>
              <input id="fx.ops.{{key}}.value" name="fx.ops.{{key}}.value" type="number" value="{{value}}" min="0" step="1" style="width:6rem;" />
            </td>

            <td class="center">
              {{#if contrib}}<span title="Sum of roster contributions">+{{contrib}}</span>{{else}}—{{/if}}
            </td>

            <td class="center"><strong>{{total}}</strong></td>

            <td class="center">
              <button type="button" class="button" data-op-roll="{{key}}" title="Roll 1d20 + (Value + Roster)">
                <i class="fas fa-dice-d20"></i> d20
              </button>
            </td>

            <td class="center">
              <div class="flexrow" style="gap:.25rem; justify-content:center;">
                <a class="button" data-op-dec="{{key}}" title="Decrease"><i class="fas fa-minus"></i></a>
                <a class="button" data-op-inc="{{key}}" title="Increase"><i class="fas fa-plus"></i></a>
              </div>
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </fieldset>

    {{!-- ===================== ROSTER ===================== --}}
    <fieldset style="border:1px solid #666; border-radius:8px; padding:.6rem;">
      <legend style="padding:0 .25rem;">Roster</legend>

      {{#if fx.roster.length}}
      <table class="bbttcc-table" style="width:100%;">
        <thead>
          <tr>
            <th style="text-align:left;">Character</th>
            <th>Violence</th>
            <th>Non-Lethal</th>
            <th>Intrigue</th>
            <th>Economy</th>
            <th>Softpower</th>
            <th>Diplomacy</th>
            <th>Logistics</th>
            <th>Culture</th>
            <th>Faith</th>
            <th>Total</th>
            <th>Open</th>
          </tr>
        </thead>
        <tbody>
          {{#each fx.roster}}
          <tr>
            <td>
              <div class="flexrow" style="align-items:center; gap:.5rem;">
                <img src="{{img}}" width="24" height="24" style="border-radius:4px;"/> <span>{{name}}</span>
              </div>
            </td>
            <td class="center">{{violence}}</td>
            <td class="center">{{nonlethal}}</td>
            <td class="center">{{intrigue}}</td>
            <td class="center">{{economy}}</td>
            <td class="center">{{softpower}}</td>
            <td class="center">{{diplomacy}}</td>
            <td class="center">{{logistics}}</td>
            <td class="center">{{culture}}</td>
            <td class="center">{{faith}}</td>
            <td class="center"><strong>{{total}}</strong></td>
            <td class="center">
              <a class="button" data-open-actor="{{id}}" title="Open character"><i class="fas fa-user"></i></a>
            </td>
          </tr>
          {{/each}}
          <tr>
            <td style="text-align:right;"><strong>Roster Totals</strong></td>
            <td class="center"><strong>{{fx.rosterTotals.violence}}</strong></td>
            <td class="center"><strong>{{fx.rosterTotals.nonlethal}}</strong></td>
            <td class="center"><strong>{{fx.rosterTotals.intrigue}}</strong></td>
            <td class="center"><strong>{{fx.rosterTotals.economy}}</strong></td>
            <td class="center"><strong>{{fx.rosterTotals.softpower}}</strong></td>
            <td class="center"><strong>{{fx.rosterTotals.diplomacy}}</strong></td>
            <td class="center"><strong>{{fx.rosterTotals.logistics}}</strong></td>
            <td class="center"><strong>{{fx.rosterTotals.culture}}</strong></td>
            <td class="center"><strong>{{fx.rosterTotals.faith}}</strong></td>
            <td class="center"><strong>{{fx.rosterGrandTotal}}</strong></td>
            <td></td>
          </tr>
        </tbody>
      </table>
      {{else}}
        <em style="opacity:.7;">No linked characters yet.</em>
      {{/if}}
      <p class="hint" style="opacity:.75; margin:.5rem 0 0;">
        Character contributions are informational; per-category totals = Value + Roster.
      </p>
    </fieldset>

    {{!-- ===================== TERRITORY SUMMARY (THIS SCENE) ===================== --}}
    {{#if fx.territoryThisScene}}
    <fieldset style="border:1px solid #666; border-radius:8px; padding:.6rem;">
      <legend style="padding:0 .25rem;">Territory — This Scene</legend>
      <div class="flexrow" style="gap:1rem; align-items:center;">
        <div><strong>Owned Hexes:</strong> {{fx.territoryThisScene.count}}</div>
        <div><strong>Resources (per turn):</strong>
          Food {{fx.territoryThisScene.resources.food}} •
          Materials {{fx.territoryThisScene.resources.materials}} •
          Trade {{fx.territoryThisScene.resources.trade}} •
          Military {{fx.territoryThisScene.resources.military}} •
          Knowledge {{fx.territoryThisScene.resources.knowledge}}
        </div>
      </div>
      {{#if fx.territoryThisScene.names.length}}
        <p class="hint" style="margin-top:.25rem; opacity:.8;">
          Hexes: {{#each fx.territoryThisScene.names}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}
        </p>
      {{/if}}
    </fieldset>
    {{/if}}

    {{!-- ===================== WAR LOGS (READ-ONLY) ===================== --}}
    <fieldset style="border:1px solid #666; border-radius:8px; padding:.6rem;">
      <legend style="padding:0 .25rem;">War Logs</legend>
      {{#if fx.warLogs.length}}
      <table class="bbttcc-table" style="width:100%;">
        <thead>
          <tr>
            <th style="width:9rem;">Date</th>
            <th style="width:14rem;">Opponent</th>
            <th style="width:8rem;">Outcome</th>
            <th>Summary</th>
          </tr>
        </thead>
        <tbody>
          {{#each fx.warLogs}}
          <tr>
            <td><small>{{date}}</small></td>
            <td>{{opponent}}</td>
            <td class="center">
              {{#if (bbttcc_eq outcome "win")}}<span style="color:#2e8b57; font-weight:600;">Win</span>{{/if}}
              {{#if (bbttcc_eq outcome "loss")}}<span style="color:#b22222; font-weight:600;">Loss</span>{{/if}}
              {{#if (bbttcc_eq outcome "stalemate")}}<span style="color:#666;">Stalemate</span>{{/if}}
              {{#unless outcome}}—{{/unless}}
            </td>
            <td>{{summary}}</td>
          </tr>
          {{/each}}
        </tbody>
      </table>
      {{else}}
        <em style="opacity:.7;">No war logs recorded.</em>
      {{/if}}
      <p class="hint" style="opacity:.75; margin:.5rem 0 0;">
        Read-only for now. We’ll add “Add/Edit/Delete” next.
      </p>
    </fieldset>

  </section>
</form>
